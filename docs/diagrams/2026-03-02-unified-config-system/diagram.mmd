flowchart TD
    classDef primary fill:#0072B2,stroke:#005a8c,color:#fff,stroke-width:2px
    classDef info fill:#56B4E9,stroke:#2A8ABF,color:#000,stroke-width:2px
    classDef success fill:#009E73,stroke:#006B4F,color:#fff,stroke-width:2px
    classDef warning fill:#E69F00,stroke:#B37A00,color:#000,stroke-width:2px
    classDef danger fill:#D55E00,stroke:#A34800,color:#fff,stroke-width:2px
    classDef highlight fill:#F0E442,stroke:#8A8200,color:#000,stroke-width:3px
    classDef accent fill:#CC79A7,stroke:#A35E85,color:#000,stroke-width:2px

    START([Session Start]):::primary --> HOOK[SessionStart Hook<br/>bootstrap.ts]:::primary
    HOOK --> READ{Config exists?}:::warning
    READ -->|Yes| PARSE[Parse config.yaml<br/>regex flat YAML]:::info
    READ -->|No| CREATE[Create config<br/>atomic wx mode]:::success
    CREATE --> PARSE
    PARSE --> VALIDATE[Validate fields<br/>docs_path + mermaid_theme]:::info
    VALIDATE --> INJECT[Inject into<br/>session context]:::success

    INJECT --> SKILLS

    subgraph SKILLS ["Skills (Runtime)"]
        direction LR
        S1[research]:::accent
        S2[brainstorm]:::accent
        S3[frontmatter]:::accent
        S4[visualize]:::accent
        S5[add command]:::accent
    end

    SKILLS --> FALLBACK

    subgraph FALLBACK ["3-Step Fallback Chain"]
        F1[1. Session context<br/>CORTEX_DOCS_PATH]:::success
        F2[2. Read config.yaml<br/>directly]:::info
        F3[3. Hardcoded default<br/>~/.local/share/cortex/docs]:::warning
        F1 -->|missing| F2
        F2 -->|missing| F3
    end

    SETUP([/cortex:setup]):::highlight --> READCFG[Read config.yaml]:::info
    READCFG --> PROMPT[Walk fields<br/>numbered lists]:::info
    PROMPT --> WRITE[Edit config.yaml<br/>read-modify-write]:::success
    WRITE --> NOTE[New session needed<br/>for changes]:::danger
