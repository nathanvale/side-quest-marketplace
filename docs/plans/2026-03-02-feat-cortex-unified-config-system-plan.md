---
title: "Unified Config System with Setup Skill"
type: feat
status: active
date: 2026-03-02
origin: docs/plans/2026-02-28-feat-cortex-configurable-global-docs-plan.md
supersedes: docs/plans/2026-02-28-feat-cortex-configurable-global-docs-plan.md
tags: [cortex, config, xdg, hooks, session-start, setup, yaml]
project: cortex-engineering
---

> **Origin:** docs/plans/2026-02-28-feat-cortex-configurable-global-docs-plan.md (superseded -- this plan expands scope from `docs_path`-only to a unified config system with setup skill)
>
> **Brainstorms:** docs/brainstorms/2026-02-28-cortex-global-docs-storage.md, docs/brainstorms/2026-02-27-cortex-brainstorm.md

# feat: Unified config system with setup skill

## Overview

Extend the Cortex config system from a single `docs_path` field to a flat YAML config at `~/.config/cortex/config.yaml` covering docs storage and mermaid theming, with a setup skill for interactive configuration. The SessionStart bootstrap hook auto-creates config with sensible defaults on first session. The config is designed to grow -- review agent preferences and other fields can be added when consumers exist.

This supersedes the original "configurable global docs" plan by adding `mermaid_theme`, a setup skill, and an extensible config parser that handles more than one field.

## Problem Statement

1. **Hardcoded paths** -- 5 runtime files still reference `~/code/my-agent-cortex/docs/`. Community users who install the plugin have nowhere for global docs to go.

2. **No setup flow** -- no way for users to configure the plugin interactively. The bootstrap hook handles zero-config defaults, but users who want to customize must know to manually edit a YAML file they've never seen.

3. **Single-field config won't scale** -- the bootstrap hook currently handles only `docs_path` with a single regex. Adding `mermaid_theme` (and future fields) needs a proper flat parser with validation, comment stripping, and extensible schema.

## Proposed Solution

1. **Flat YAML config** at `~/.config/cortex/config.yaml` -- regex-parseable, no YAML library needed, all fields optional with defaults
2. **SessionStart bootstrap hook** creates config + data dirs on first session, injects all resolved values into session context
3. **`/cortex:setup` skill** walks users through configuring all options interactively using numbered lists (not AskUserQuestion -- per skill authoring conventions)
4. **Update 5 skill/command files** to use the config-resolved docs path via fallback chain
5. **XDG-compliant directory split** -- config at `~/.config/cortex/`, data at `~/.local/share/cortex/docs/`

## Config Schema

### Design Principles

- **Flat key:value only** -- no nesting, regex-parseable without YAML library
- **All fields optional** -- empty file or missing file is valid (everything defaults)
- **Unknown keys warn, never error** -- forward compatibility (future fields like `stack`, `review_depth` can be added without breaking existing configs)
- **Closed enums with documented values** -- typos get warnings + fallback to default
- **Inline comments stripped** -- `key: value # comment` parsed correctly
- **Quoted values stripped** -- `key: "value"` parsed as `value` (matched pairs only -- mismatched quotes are not stripped)
- **Only ship fields with consumers** -- `docs_path` is consumed by 4 skills + visualize, `mermaid_theme` by the visualize skill. Review preferences (`stack`, `review_depth`, `review_focus`) will be added when compound-engineering integration is planned.

### Schema Definition

```yaml
# ~/.config/cortex/config.yaml
# All values shown are defaults. Only specify what you want to override.
# Generated by /cortex:setup or auto-created on first session.

# --- Knowledge Storage ---
# Where to store global knowledge documents (research, brainstorms, plans, etc.)
# Must resolve under $HOME. Supports ~ expansion.
# Default: ~/.local/share/cortex/docs (XDG-compliant)
docs_path: ~/.local/share/cortex/docs

# --- Mermaid Diagrams ---
# Default theme preset for diagram generation.
# Values: default, sketch, blueprint
mermaid_theme: default
```

### Field Reference

| Field | Type | Default | Allowed Values | Validation |
|-------|------|---------|---------------|------------|
| `docs_path` | path string | `~/.local/share/cortex/docs` | Any path under `$HOME` | Single-line, path-safe chars (`[/a-zA-Z0-9._\- ]`), max 512 chars, resolves under `$HOME`, ~ expanded |
| `mermaid_theme` | enum string | `default` | `default`, `sketch`, `blueprint` | Closed enum; unknown values warn + default |

## Technical Approach

### Architecture

```
~/.config/cortex/
  config.yaml                    # User preferences (flat key:value)

~/.local/share/cortex/
  docs/                          # Knowledge documents (XDG data)
    research/
    brainstorms/
    plans/
    decisions/
    meetings/
    diagrams/
```

**Resolution chain (per XDG spec):**

```
Config dir: $XDG_CONFIG_HOME/cortex/ > ~/.config/cortex/
Data dir:   $XDG_DATA_HOME/cortex/docs/ > ~/.local/share/cortex/docs/
            (or docs_path from config.yaml overrides the data dir)
```

> **Note:** `$CORTEX_CONFIG_DIR` was considered but removed (YAGNI) -- `$XDG_CONFIG_HOME` already covers the custom config location use case, and a non-standard env var adds attack surface (`.envrc` poisoning) without clear benefit.

**Fallback chain for skills (3-step):**

1. Read value from session context (injected by bootstrap hook)
2. If not available, read `~/.config/cortex/config.yaml` directly
3. If config missing/unreadable, use hardcoded default

### Implementation Phases

#### Phase 1: Config Parser + Bootstrap Hook Updates

**Scope:** Get the config infrastructure working. Hook creates config, parses all fields, injects into session context.

**File: `plugins/cortex-engineering/hooks/bootstrap.ts`** (EDIT -- already exists, needs expansion)

Changes to existing 227-line implementation:

1. **Replace single-field regex with flat YAML parser:**

```typescript
/** Parse flat YAML config. Strips inline comments and matched-pair quotes. */
function parseConfig(raw: string): Record<string, string> {
  const config: Record<string, string> = {}
  for (const line of raw.split('\n')) {
    if (/^\s*(#|$)/.test(line)) continue
    const match = line.match(/^(\w+):\s*(.+?)\s*$/)
    if (match) {
      let value = match[2]
      // Strip inline comments (space + #)
      value = value.replace(/\s+#.*$/, '')
      // Strip matched-pair quotes only ("value" or 'value', not mismatched)
      value = value.replace(/^"(.*)"$/, '$1').replace(/^'(.*)'$/, '$1').trim()
      if (value) config[match[1]] = value
    }
  }
  return config
}
```

> **Note:** Comment stripping is uniform across all fields. Path validation already rejects `#` via `[/a-zA-Z0-9._\- ]`, so `#` in path values is impossible. Quote stripping uses matched pairs only -- `"value'` is left unchanged.

2. **Add field-level validation with typed schema:**

```typescript
type FieldSpec =
  | { type: 'string'; default: string }
  | { type: 'path'; default: string }
  | { type: 'enum'; default: string; allowed: string[] }

const SCHEMA: Record<string, FieldSpec> = {
  docs_path: { type: 'path', default: '~/.local/share/cortex/docs' },
  mermaid_theme: { type: 'enum', default: 'default', allowed: ['default', 'sketch', 'blueprint'] },
}
```

Discriminated union ensures `allowed` is required only on enum fields and `default` is correctly typed. Adding a new field is one line. The parser, validator, and stdout output all derive from this schema automatically.

3. **Add `resolveDefaultDocsDir()` for XDG data path:**

```typescript
/** Validate an XDG env var: must be absolute, path-safe chars, under $HOME. */
function validateXdgVar(name: string, value: string | undefined): string | null {
  if (!value) return null
  if (!value.startsWith('/')) {
    process.stderr.write(`[cortex-engineering] ${name} is not absolute, ignoring\n`)
    return null
  }
  if (!/^[/a-zA-Z0-9._\- ]+$/.test(value)) {
    process.stderr.write(`[cortex-engineering] ${name} contains unsafe characters, ignoring\n`)
    return null
  }
  return value
}

function resolveDefaultDocsDir(): string {
  const xdg = validateXdgVar('XDG_DATA_HOME', process.env.XDG_DATA_HOME)
  if (xdg) return resolve(xdg, 'cortex', 'docs')
  return resolve(homedir(), '.local', 'share', 'cortex', 'docs')
}
```

> `resolveConfigDir()` should use the same `validateXdgVar()` for `$XDG_CONFIG_HOME`. Consistent stderr prefix: `[cortex-engineering]` (matching existing code).

4. **Update `DEFAULT_CONFIG` template** to show all fields with comments (matching the schema definition above)

5. **Update `DEFAULT_DOCS_PATH`** from `'~/.config/cortex/docs'` to `'~/.local/share/cortex/docs'`

> **Note:** Architecture review flagged the default path change as a potential breaking change, but there are no existing users of this plugin yet -- the XDG-correct path (`~/.local/share/cortex/docs`) can be set as the default from day one without migration logic.

6. **Expand hook stdout** to inject all config values:

```
## Cortex Knowledge System

**CORTEX_DOCS_PATH:** `/Users/nathan/.local/share/cortex/docs`
**CORTEX_CONFIG:** `/Users/nathan/.config/cortex/config.yaml`
**CORTEX_MERMAID_THEME:** `default`

### Agent Capabilities

- Read/write knowledge docs at the path above
- To read a specific config value: read the config file and extract the field
- Edit config: `open ~/.config/cortex/config.yaml`
- Run `/cortex:setup` to reconfigure interactively
- To reset config to defaults: delete the config file. The values shown above remain valid for this session (resolved from defaults as fallback). Next session will regenerate the file.
- Subdirectories: research, brainstorms, plans, decisions, meetings, diagrams
```

7. **Security hardening for all injected values:**
   - Enum fields: reject values not in allowed set (prevents prompt injection via crafted values containing newlines)
   - Path field: existing `validateDocsPath()` already handles this -- max 512 chars, path-safe chars only
   - All fields: single-line enforcement (reject if contains `\n`)
   - XDG env vars (`$XDG_CONFIG_HOME`, `$XDG_DATA_HOME`): validate path-safe characters (`[/a-zA-Z0-9._\- ]`) and under-`$HOME` enforcement, same as `docs_path`. Prevents `.envrc` poisoning via crafted paths.
   - Stdout injection: all values truncated to 512 chars and backticks escaped before interpolation into markdown context

**Existing bootstrap.ts patterns preserved:**
- Self-destruct timer with `.unref()` (first executable line) -- **update to 4s** (align with 5s hooks.json timeout)
- Atomic config creation with `{ flag: 'wx', mode: 0o600 }`
- Self-contained utilities (no imports)
- Matcher: `"*"` (fires on startup, resume, clear, AND compact -- ensures config survives compaction)
- Timeout: 5s (reduced from 10s -- hook completes in ~15ms, 5s is generous)

---

**File: `plugins/cortex-engineering/hooks/hooks.json`** (NEW)

```json
{
  "description": "Bootstrap Cortex knowledge system at session start",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bun run \"${CLAUDE_PLUGIN_ROOT}/hooks/bootstrap.ts\"",
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

> **Why `"*"` matcher:** Fires on startup, resume, clear, AND compact. Ensures config is re-injected after context compaction. The hook is idempotent (reads config, creates nothing if dirs exist) so re-firing is safe and fast (~15ms).
>
> **Why 5s timeout:** Hook completes in ~15ms. 5s is 300x headroom. Self-destruct timer is 4s (always shorter than external timeout).

---

**File: `plugins/cortex-engineering/.claude-plugin/plugin.json`** (EDIT)

- Update `"repository"` URL from `my-agent-cortex` to `side-quest-marketplace`
- Bump version to `0.5.0` (minor: new feature)
- Add `"./skills/setup"` to skills array
- Add `"./commands/setup.md"` to commands array
- Do NOT add `"hooks"` field (auto-discovered by convention)

#### Phase 2: Setup Skill

**File: `plugins/cortex-engineering/skills/setup/SKILL.md`** (NEW)

The setup skill provides interactive configuration management. It uses numbered lists for user input (per skill authoring conventions -- no `AskUserQuestion`).

**Key design decisions:**
- **Accepts optional argument** -- `/cortex:setup` walks through everything, `/cortex:setup docs_path` jumps to that field
- **Read-modify-write** -- preserves comments and unknown keys in config.yaml (Claude uses Read + Edit tools on the file, not programmatic rewriting)
- **Shows current values** -- displays what's configured before asking what to change
- **Deferred effect** -- writes file, then notes "start a new session for changes to take effect" (session context is set at session start by the hook and can't be updated mid-conversation)
- **Mid-session staleness note** -- after writing config, the skill tells Claude: "If you need to use the new values immediately in this session, read them directly from config.yaml rather than relying on session context." This turns the 3-step fallback chain into a feature -- skills can bypass stale session context by going to step 2 (read file).

**Skill flow:**

1. Read existing `~/.config/cortex/config.yaml` (or detect absence)
2. If `$ARGUMENTS` specifies a single field, jump to that field's configuration
3. Otherwise, display current effective config (file values + defaults for missing keys)
4. Walk through each section using numbered lists:
   - Knowledge Storage: docs_path
   - Mermaid: mermaid_theme
5. For each field: show current value, allowed values, ask for new value or "keep current"
6. Write updated config.yaml using Edit tool (preserves comments and surrounding content)
7. Confirm changes and note: "Start a new session for changes to take effect."

**Read-modify-write strategy:**

```
For each changed key:
  1. If key exists in file: replace the line (preserve surrounding content)
  2. If key doesn't exist: append before the next section comment or at EOF
  3. If file doesn't exist: write full template with user's chosen values
```

---

**File: `plugins/cortex-engineering/commands/setup.md`** (NEW)

Thin command wrapper:

```yaml
---
name: setup
description: Configure cortex-engineering settings interactively. Manages ~/.config/cortex/config.yaml.
argument-hint: "[field-name]"
disable-model-invocation: true
---
```

Body: "Use the setup skill to configure cortex-engineering. If a field name is provided ($ARGUMENTS), configure only that field."

#### Phase 3: Update Skills and Commands

Replace hardcoded `~/code/my-agent-cortex/docs/` references with the **fallback chain pattern** in all 5 runtime files.

**Fallback chain prose (for skill text):**

> Save to `<CORTEX_DOCS_PATH>/<type>/`. The bootstrap hook injects this path at session start. If missing, read `docs_path` from `~/.config/cortex/config.yaml`; if that's also missing, use `~/.local/share/cortex/docs/`.

Skills don't need to explain the resolution chain -- they just reference the injected path. The hook handles resolution; skills just consume the result.

**Sub-agent context requirement (for skills that spawn Task agents):**

> When spawning sub-agents via the Task tool, ALWAYS start the task prompt with the following context block. Sub-agents do not inherit session context:
>
> ```
> Cortex config: CORTEX_DOCS_PATH=<resolved-path>, CORTEX_MERMAID_THEME=<resolved-theme>, CORTEX_CONFIG=<config-path>
> ```
>
> Including `CORTEX_CONFIG` enables sub-agents to read config.yaml directly if passed values are stale (e.g., setup was run mid-session). A copy-paste pattern is more reliable than a behavioral instruction for LLM skill execution.

**Files to update:**

| File | Changes |
|------|---------|
| `skills/frontmatter/SKILL.md` | Update File Location table (global path + project path to `./docs/`) |
| `skills/research/SKILL.md` | Update grep path, save path, example project name, add sub-agent note |
| `skills/brainstorm/SKILL.md` | Update grep path, save path, example project name, add sub-agent note |
| `skills/visualize/SKILL.md` | Wire `CORTEX_MERMAID_THEME` consumption (Edit 4a), add global fallback to diagram save path (Edit 4b) |
| `commands/add.md` | Update save path, add sub-agent note |

See **Appendix A** for exact diffs (carried forward from the original plan with path corrections).

#### Phase 4: Verify

1. Run `bun run validate` -- confirm marketplace validation passes
2. Manual verification (see Verification section below)

## Alternative Approaches Considered

### 1. Nested YAML config

**Rejected.** Nesting (e.g., `mermaid: { theme: sketch }`) requires a YAML library to parse. The bootstrap hook runs on every session start -- regex parsing saves ~20ms and has zero dependencies. Flat key:value with naming convention (`mermaid_theme`) achieves the same grouping without parsing complexity.

### 2. JSON config

**Rejected.** YAML is more human-friendly for manual editing. Comments are essential for self-documenting config. Every modern CLI tool uses YAML or TOML, not JSON, for user-facing config.

### 3. TOML config

**Considered.** TOML is arguably better for flat config (no quoting ambiguity). But YAML is already established in the codebase (frontmatter everywhere), and regex-parsed flat YAML is effectively the same as TOML for our use case.

### 4. Separate config files per concern

**Rejected.** Having `docs-config.yaml` and `mermaid-config.yaml` spreads user attention. One file with sections (via comments) is simpler.

## System-Wide Impact

### Interaction Graph

- **SessionStart hook** fires on startup/clear -> reads config.yaml -> validates all fields -> injects into session context -> all skills can read values
- **Skills** read from session context (fast path) or config.yaml (fallback) -> use resolved values for file paths and theme choice
- **`/cortex:setup`** reads config.yaml -> prompts user -> writes config.yaml -> user starts new session -> hook picks up changes

### Error Propagation

- **Malformed config.yaml:** Hook logs warning to stderr AND stdout, falls back to defaults for all fields. Skills continue working.
- **Missing config.yaml:** Hook creates it atomically. If creation fails (permissions), hook logs error, skills fall back to hardcoded defaults.
- **Invalid field value:** Warning logged, that field falls back to default. Other fields unaffected.
- **Hook doesn't fire (#11509):** Skills read config.yaml directly (fallback step 2). If that also fails, hardcoded defaults (step 3).
- **Disk full during write:** `writeFileSync` throws. Bootstrap hook catches at top level, logs error, continues with defaults.

### State Lifecycle Risks

- **Partial config write:** The `{ flag: 'wx' }` atomic create prevents partial first-write. The setup skill's read-modify-write could leave a partial file on crash -- but this is a user-initiated action, not automatic.
- **Two sessions writing simultaneously:** Extremely unlikely (setup is interactive). Last write wins. No data corruption risk since YAML is text.
- **Config values in compacted context:** After compaction, session context values may be lost. The fallback chain handles this -- skills read config.yaml directly.

### API Surface Parity

- **Skills consuming docs_path:** frontmatter, research, brainstorm, add (4 files)
- **Skills consuming mermaid_theme:** visualize (via mermaid-diagrams skill references)

## Acceptance Criteria

### Config Infrastructure

- [ ] `~/.config/cortex/config.yaml` created atomically on first session with all fields documented as comments
- [ ] Hook respects `$XDG_CONFIG_HOME` and `$XDG_DATA_HOME` (validated as absolute, path-safe chars, under `$HOME`)
- [ ] Both config fields (`docs_path`, `mermaid_theme`) parsed and validated by bootstrap hook
- [ ] `mermaid_theme` enum rejects unknown values with warning + fallback to default
- [ ] Inline comments stripped from all values (`key: value # comment` -> `value`)
- [ ] Quoted values stripped (`key: "value"` -> `value`)
- [ ] Unknown keys warned but not rejected (forward compatibility for future fields)
- [ ] All validated values injected into session context via stdout
- [ ] Security: all injected values single-line enforced, enum-validated (prevents prompt injection)
- [ ] Hook idempotent -- subsequent sessions read config, create nothing
- [ ] Self-destruct timer with `.unref()` as first executable line
- [ ] Matcher `"*"` (fires on startup, resume, clear, compact -- ensures config survives compaction)
- [ ] `hooks.json` created to register the SessionStart hook (auto-discovered, no `"hooks"` in plugin.json)

### Setup Skill

- [ ] `/cortex:setup` walks through all config fields using numbered lists
- [ ] `/cortex:setup <field>` jumps directly to that field
- [ ] Shows current effective values before prompting
- [ ] Read-modify-write preserves comments and unknown keys
- [ ] Creates config.yaml from template if file doesn't exist
- [ ] File permissions preserved (mode 0o600)
- [ ] Confirms changes and notes "start a new session for changes to take effect"

### Skill Updates

- [ ] 4 runtime files use fallback chain: session context > read config.yaml > default `~/.local/share/cortex/docs/`
- [ ] visualize/SKILL.md updated to consume `CORTEX_MERMAID_THEME` from session context (Edit 4a) and global diagram save path (Edit 4b)
- [ ] Skills that spawn Task agents include docs path in prompt
- [ ] No hardcoded `my-agent-cortex` references in any runtime file

### Plugin Manifest

- [ ] Repository URL updated to `side-quest-marketplace`
- [ ] Version bumped to `0.5.0`
- [ ] Setup skill and command registered
- [ ] No `"hooks"` field (auto-discovered)
- [ ] `bun run validate` passes

## Known Risk: SessionStart Hook Bug

[Issue #11509](https://github.com/anthropics/claude-code/issues/11509) -- SessionStart hooks may not fire for local file-based marketplace plugins. Still open as of Feb 2026.

**Mitigation:** The 3-step fallback chain makes every skill resilient to hook failure. The `/cortex:setup` skill works independently of the hook.

## Edge Cases

| Edge Case | Handling |
|-----------|----------|
| First session (no config) | Hook creates config + data dirs atomically (`{ flag: 'wx' }`) |
| `$XDG_CONFIG_HOME` / `$XDG_DATA_HOME` set | Validated: absolute, path-safe chars. Unsafe values ignored with warning. |
| Symlinked `~/.config/` | Hook follows symlinks -- works with Stow/chezmoi |
| Malformed or empty config.yaml | Falls back to defaults for all fields, warns in stderr + stdout |
| Unknown keys in config | Warned, preserved on read-modify-write |
| `docs_path` outside `$HOME` or with newlines | Validation rejects, fallback to default |
| Hook doesn't fire (#11509) | Skills fallback chain: read config.yaml > hardcoded default |
| Context lost in compaction | Hook re-fires (`"*"` matcher); skills also fall back to reading config.yaml |
| Sub-agent via Task | Parent passes config values + config path in Task prompt |
| Post-setup staleness | Setup notes: "read config.yaml directly for new values this session" |

## Performance Profile

Benchmarked on M4 Pro with Bun 1.3.9 (from original plan):

| Operation | Time |
|-----------|------|
| Bun cold start | ~10ms |
| Config read + regex parse (2 fields) | ~2ms |
| Validation + resolve | <1ms |
| `mkdirSync` x7 (existing dirs, no-op) | ~13ms |
| Stdout write | <1ms |
| **Total (end-to-end)** | **~25-27ms** |
| Human perception threshold | ~100ms |

Adding fields to the regex parser adds negligible time (<0.1ms each). Well under the 100ms perceptual threshold and 300x under the 5s timeout.

## What's NOT in This Plan

- **Review config fields** (`stack`, `review_depth`, `review_focus`) -- add when compound-engineering integration is planned. Schema supports one-line additions.
- `config_version` field -- YAGNI, no consumer or migration logic. Add when needed.
- `$CLAUDE_ENV_FILE` writes -- security risk outweighs benefit. Stdout + file fallback is sufficient.
- `sources` array, `viewer` config, per-project `.cortex.yaml` overrides (future)
- `cortex init` CLI, `cortex config` CLI, `/cortex:config` read-only view (future)
- PreCompact hook, SubagentStart hook (future -- MVP uses `"*"` matcher + prompt passing)
- Automated migration from `~/code/my-agent-cortex/docs/` (manual -- user sets `docs_path`)
- `theme` field for custom Mermaid JSON config path (future -- `mermaid_theme` preset is sufficient)

## Verification

1. Delete `~/.config/cortex/` and `~/.local/share/cortex/`, start new session -- verify config + data dirs created, session context shows `CORTEX_DOCS_PATH`, `CORTEX_CONFIG`, `CORTEX_MERMAID_THEME`
2. Run `/cortex:setup` -- verify it shows current config, change `docs_path`, confirm deferred-effect note
3. Start new session -- verify hook reads custom docs path and creates subdirs there
4. Set `mermaid_theme: forest` in config.yaml, start session -- verify warning + fallback to `default`
5. Run `/cortex:research "test topic"` -- verify it saves to the configured global path
6. Temporarily rename `hooks.json`, start session -- verify skill resolves path via config.yaml directly (fallback chain step 2)
7. Run `bun run validate`

## Files Changed Summary

| File | Change Type | Phase |
|------|------------|-------|
| `plugins/cortex-engineering/hooks/bootstrap.ts` | EDIT (expand) | 1 |
| `plugins/cortex-engineering/hooks/hooks.json` | NEW | 1 |
| `plugins/cortex-engineering/.claude-plugin/plugin.json` | EDIT | 1 |
| `plugins/cortex-engineering/skills/setup/SKILL.md` | NEW | 2 |
| `plugins/cortex-engineering/commands/setup.md` | NEW | 2 |
| `plugins/cortex-engineering/skills/frontmatter/SKILL.md` | EDIT | 3 |
| `plugins/cortex-engineering/skills/research/SKILL.md` | EDIT | 3 |
| `plugins/cortex-engineering/skills/brainstorm/SKILL.md` | EDIT | 3 |
| `plugins/cortex-engineering/skills/visualize/SKILL.md` | EDIT | 3 |
| `plugins/cortex-engineering/commands/add.md` | EDIT | 3 |

## Decisions Made

**Carried from original plan (see: docs/plans/2026-02-28-feat-cortex-configurable-global-docs-plan.md):**
- XDG-correct split: config at `~/.config/cortex/`, docs at `~/.local/share/cortex/docs/`
- SessionStart hook for bootstrap (auto-discovered via `hooks.json`)
- 3-step fallback chain for all skills
- Regex parsing over YAML library
- Atomic config creation with `{ flag: 'wx' }`
- `timer.unref()` mandatory
- Sub-agent context via prompt passing (MVP)

**New decisions for unified config:**
- **Flat YAML over nested** -- regex-parseable, no library dependency
- **All fields optional with defaults** -- zero-config works out of the box
- **Only ship fields with consumers** -- `docs_path` (4 skills), `mermaid_theme` (visualize skill). Review fields deferred until compound-engineering integration is planned.
- **Closed enums** -- reject unknown values with warning + fallback (prevents prompt injection, catches typos)
- **Comment and quote stripping** -- handles idiomatic YAML patterns users will naturally write
- **Read-modify-write for setup** -- Claude uses Edit tool on config.yaml, preserving comments and unknown keys
- **Setup uses numbered lists** -- not AskUserQuestion (per skill authoring conventions)
- **Setup accepts optional field argument** -- `/cortex:setup docs_path` for quick single-field changes
- **No `config_version` field** -- YAGNI, no consumer or migration logic. Add when needed.
- **No `$CLAUDE_ENV_FILE` writes** -- security risk (shell injection via unvalidated `configPath`) outweighs benefit. Stdout + file fallback is sufficient.
- **Uniform comment stripping** -- no type-aware dispatch. Path validation already rejects `#`, making the edge case impossible.
- **Matched-pair quote stripping** -- `"value"` or `'value'` stripped, but `"value'` left unchanged. More predictable than independent leading/trailing strip.
- **XDG env vars validated for safe characters** -- same path-safe charset as `docs_path`, prevents `.envrc` poisoning
- **Stdout values length-capped at 512 chars** -- prevents prompt injection via crafted long path values
- **Discriminated union for `FieldSpec`** -- `allowed` required only on enum fields, type-safe defaults

## Sources & References

### Origin

- **Original plan:** docs/plans/2026-02-28-feat-cortex-configurable-global-docs-plan.md (superseded)
- **Global docs brainstorm:** docs/brainstorms/2026-02-28-cortex-global-docs-storage.md
- **Cortex vision brainstorm:** docs/brainstorms/2026-02-27-cortex-brainstorm.md
- **Compound-engineering setup skill:** (inspiration for interactive setup pattern)

### Internal References

- `plugins/cortex-engineering/hooks/bootstrap.ts` -- existing reference implementation (227 lines)
- `plugins/cortex-engineering/.claude-plugin/plugin.json` -- plugin manifest
- `plugins/cortex-engineering/skills/` -- 7 existing skills
- `docs/research/2026-02-28-cortex-docs-storage-community-patterns.md` -- XDG patterns
- `docs/research/2026-03-01-naming-conventions-claude-code-plugins.md` -- naming conventions

### External References

- XDG Base Directory Specification: freedesktop.org/basedir
- Command Line Interface Guidelines: clig.dev
- direnv XDG migration precedent: github.com/direnv/direnv/issues/406
- SessionStart hook bug: github.com/anthropics/claude-code/issues/11509

### Related Work

- Compound-engineering `/setup` skill (per-project markdown config -- pattern inspiration)
- Atuin, Starship, Lazygit (flat config with comments pattern)

---

## Appendix A: Skill File Diffs

Carried forward from the original plan with corrected paths (`plugins/cortex-engineering/` not `plugins/cortex/`).

### Edit 1: `plugins/cortex-engineering/skills/frontmatter/SKILL.md`

**File Location table**

BEFORE:
```markdown
## File Location

| Context | Location |
|---------|----------|
| No project context / global | `~/code/my-agent-cortex/docs/<type>/` |
| Working in a project repo | `~/code/<project>/docs/<type>/` |
```

AFTER:
```markdown
## File Location

| Context | Location |
|---------|----------|
| No project context / global | `<CORTEX_DOCS_PATH>/<type>/` |
| Working in a project repo | `./docs/<type>/` |
```

### Edit 2: `plugins/cortex-engineering/skills/research/SKILL.md`

**Edit 2a: grep path**

BEFORE:
```markdown
Or grep the docs folders directly:

```bash
grep -rl "<topic>" ~/code/my-agent-cortex/docs/ 2>/dev/null
```

AFTER:
```markdown
Or grep the global docs folder:

```bash
grep -rl "<topic>" <CORTEX_DOCS_PATH>/ 2>/dev/null
```

**Edit 2b: save path**

BEFORE:
```markdown
**File location:**
- If in a project repo: `./docs/research/YYYY-MM-DD-<slug>.md`
- If no project context: `~/code/my-agent-cortex/docs/research/YYYY-MM-DD-<slug>.md`
```

AFTER:
```markdown
**File location:**
- If in a project repo: `./docs/research/YYYY-MM-DD-<slug>.md`
- If no project context: `<CORTEX_DOCS_PATH>/research/YYYY-MM-DD-<slug>.md` (resolve: session context > config.yaml > default `~/.local/share/cortex/docs/`)

**Sub-agent note:** When spawning sub-agents via Task, ALWAYS start the task prompt with: `Cortex config: CORTEX_DOCS_PATH=<resolved-path>, CORTEX_MERMAID_THEME=<resolved-theme>, CORTEX_CONFIG=<config-path>`. Sub-agents do not inherit session context.
```

**Edit 2c: example project**

BEFORE: `project: my-agent-cortex`
AFTER: `project: cortex`

### Edit 3: `plugins/cortex-engineering/skills/brainstorm/SKILL.md`

**Edit 3a: grep path**

BEFORE:
```markdown
Or grep directly:

```bash
grep -rl "<topic>" ~/code/my-agent-cortex/docs/ 2>/dev/null
```

AFTER:
```markdown
Or grep the global docs folder (resolve path: session context `CORTEX_DOCS_PATH` > `~/.config/cortex/config.yaml` > default `~/.local/share/cortex/docs/`):

```bash
grep -rl "<topic>" <CORTEX_DOCS_PATH>/ 2>/dev/null
```

**Edit 3b: save path**

BEFORE:
```markdown
**File location:**
- If in a project repo: `./docs/brainstorms/YYYY-MM-DD-<slug>.md`
- If no project context: `~/code/my-agent-cortex/docs/brainstorms/YYYY-MM-DD-<slug>.md`
```

AFTER:
```markdown
**File location:**
- If in a project repo: `./docs/brainstorms/YYYY-MM-DD-<slug>.md`
- If no project context: `<CORTEX_DOCS_PATH>/brainstorms/YYYY-MM-DD-<slug>.md` (resolve: session context > config.yaml > default `~/.local/share/cortex/docs/`)

**Sub-agent note:** When spawning sub-agents via Task, ALWAYS start the task prompt with: `Cortex config: CORTEX_DOCS_PATH=<resolved-path>, CORTEX_MERMAID_THEME=<resolved-theme>, CORTEX_CONFIG=<config-path>`. Sub-agents do not inherit session context.
```

**Edit 3c: example project**

BEFORE: `project: my-agent-cortex`
AFTER: `project: cortex`

### Edit 4: `plugins/cortex-engineering/skills/visualize/SKILL.md`

> **Note:** Architecture review verified that `visualize/SKILL.md` does NOT contain any `my-agent-cortex` reference. The original plan's "example project rename" was a phantom diff carried from the superseded plan. The real edit needed here is wiring `CORTEX_MERMAID_THEME` consumption.

**Edit 4a: Add mermaid_theme consumption to style auto-detection**

Add to the style/preset selection step:

AFTER (new content to add):
```markdown
**Default preset:** Use the `CORTEX_MERMAID_THEME` value from session context. If not available, read `mermaid_theme` from `~/.config/cortex/config.yaml`. If config doesn't exist, default to `default`. Map values: `default` -> Classic, `sketch` -> Sketch, `blueprint` -> Blueprint.
```

**Edit 4b: Add global fallback to diagram save path**

The visualize skill's save step currently uses only a project-relative path. Add global fallback:

BEFORE:
```markdown
Save to `docs/diagrams/YYYY-MM-DD-<topic-slug>/`:
```

AFTER:
```markdown
**Save location:**
- If in a project repo: `./docs/diagrams/YYYY-MM-DD-<topic-slug>/`
- If no project context: `<CORTEX_DOCS_PATH>/diagrams/YYYY-MM-DD-<topic-slug>/` (resolve: session context > config.yaml > default `~/.local/share/cortex/docs/`)
```

### Edit 5: `plugins/cortex-engineering/commands/add.md`

**Save path**

BEFORE:
```markdown
Save to the appropriate location:
- If in a project repo: `./docs/research/YYYY-MM-DD-<slug>.md`
- If no project context: `~/code/my-agent-cortex/docs/research/YYYY-MM-DD-<slug>.md`
```

AFTER:
```markdown
Save to the appropriate location:
- If in a project repo: `./docs/research/YYYY-MM-DD-<slug>.md`
- If no project context: `<CORTEX_DOCS_PATH>/research/YYYY-MM-DD-<slug>.md` (resolve: session context > config.yaml > default `~/.local/share/cortex/docs/`)

**Sub-agent note:** When spawning sub-agents via Task, ALWAYS start the task prompt with: `Cortex config: CORTEX_DOCS_PATH=<resolved-path>, CORTEX_MERMAID_THEME=<resolved-theme>, CORTEX_CONFIG=<config-path>`. Sub-agents do not inherit session context.
```

---

## Appendix B: SpecFlow Gap Analysis Summary

Key gaps identified and how they're addressed:

| Gap | Resolution |
|-----|-----------|
| Inline comments in values | Strip `\s+#.*$` uniformly from all values |
| Quoted values | Strip matched-pair quotes only (`"value"` or `'value'`) |
| Setup overwrites comments | Claude uses Edit tool (read-modify-write), preserving comments |
| Injected values need prompt injection protection | Enum validation + single-line enforcement + 512-char length cap + XDG var validation |
| Setup single-field UX | Optional argument `/cortex:setup <field>` |
| Setup takes effect when? | Writes file, notes "new session needed", tells agent to read file directly |
| Skills still hardcode old paths | Phase 3 updates all 5 files with fallback chain |
| Diagram save has no global path | Edit 4b adds fallback chain to visualize skill save step |
| Sub-agents can't self-correct stale values | Template includes `CORTEX_CONFIG` path for direct file read |
